name: Tronwurp Auto Update

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  manifest_and_version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Verify project structure
        run: |
          set -e
          test -d src
          test -f src/Init.lua
          test -d src/Core
          test -d src/Modules
          test -d src/Assets
          echo "Structure OK."

      - name: Regenerate Manifest.lua
        run: |
          set -e

          OUT="src/Core/Manifest.lua"
          TMP="$(mktemp)"

          # Collect lua files under Core/ Modules/ Assets/ (files only)
          # Exclude Manifest.lua itself to avoid self-listing
          mapfile -t FILES < <(
            find src/Core src/Modules src/Assets -type f -name "*.lua" \
              ! -path "src/Core/Manifest.lua" \
              | sed 's|^src/||' \
              | LC_ALL=C sort
          )

          {
            echo "-- Auto-generated by GitHub Actions"
            echo "-- Do not edit by hand. Your changes will be overwritten."
            echo ""
            echo "return {"
            for f in "${FILES[@]}"; do
              echo "    \"${f}\","
            done
            echo "}"
          } > "$TMP"

          # Replace only if changed
          if [ ! -f "$OUT" ]; then
            mkdir -p "$(dirname "$OUT")"
            cp "$TMP" "$OUT"
            echo "Manifest created."
          else
            if ! cmp -s "$TMP" "$OUT"; then
              cp "$TMP" "$OUT"
              echo "Manifest updated."
            else
              echo "Manifest unchanged."
            fi
          fi

      - name: Auto bump VERSION (patch)
        run: |
          set -e

          if [ ! -f VERSION ]; then
            echo "0.0.0" > VERSION
          fi

          OLD_VERSION="$(cat VERSION | tr -d '\r\n')"

          # Fallback if VERSION is weird
          if ! echo "$OLD_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            OLD_VERSION="0.0.0"
          fi

          IFS='.' read -r MAJOR MINOR PATCH <<< "$OLD_VERSION"
          PATCH=$((PATCH+1))
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"

          echo "$NEW_VERSION" > VERSION
          echo "Version bumped: $OLD_VERSION -> $NEW_VERSION"

      - name: Commit & Push changes (if any)
        run: |
          set -e

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add src/Core/Manifest.lua VERSION

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: auto-update manifest and version"
          git push
