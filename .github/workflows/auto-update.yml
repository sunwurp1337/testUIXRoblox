name: Tronwurp Auto Update (Manifest)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  regenerate_manifest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Regenerate src/Core/Manifest.lua from ALL lua files under src/
        run: |
          set -e

          OUT="src/Core/Manifest.lua"
          TMP="$(mktemp)"

          # Find ALL .lua under src/ (any folders), exclude Manifest itself
          mapfile -t FILES < <(
            find src -type f -name "*.lua" \
              ! -path "src/Core/Manifest.lua" \
              | sed 's|^src/||' \
              | LC_ALL=C sort
          )

          # Write manifest
          mkdir -p "$(dirname "$OUT")"

          {
            echo "-- Auto-generated by GitHub Actions"
            echo "-- Do not edit by hand. Your changes will be overwritten."
            echo ""
            echo "return {"
            for f in "${FILES[@]}"; do
              echo "    \"${f}\","
            done
            echo "}"
          } > "$TMP"

          # Replace only if changed
          if [ ! -f "$OUT" ] || ! cmp -s "$TMP" "$OUT"; then
            cp "$TMP" "$OUT"
            echo "Manifest updated."
          else
            echo "Manifest unchanged."
          fi

      - name: Commit & Push (if changed)
        run: |
          set -e

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add src/Core/Manifest.lua

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: auto-update manifest"
          git push
